<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Kaustubh Grand Prix â€” 4th Birthday Edition</title>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  *, *::before, *::after { margin:0; padding:0; box-sizing:border-box; }
  html, body {
    width:100%; height:100%;
    background: #0a0a0f;
    display:flex; align-items:center; justify-content:center;
    overflow:hidden;
  }
  #wrap {
    position:relative;
    display:flex; flex-direction:column; align-items:center;
    gap:0;
  }
  canvas {
    display:block;
    border-radius:4px;
    box-shadow: 0 0 0 2px #c00, 0 0 40px rgba(220,0,0,0.4), 0 0 80px rgba(220,0,0,0.15);
  }
  #footer {
    width:100%;
    background:#0c0c14;
    border-top:1px solid #222;
    padding:6px 20px;
    display:flex; align-items:center; justify-content:space-between;
    font-family:'Rajdhani', sans-serif;
    font-size:13px; color:#555;
  }
  #footer span { color:#ff4444; }

  /* â”€â”€ Overlay screens â”€â”€ */
  #overlay {
    position:absolute; inset:0;
    display:flex; align-items:center; justify-content:center;
    pointer-events:none;
  }
  .screen {
    pointer-events:all;
    background: linear-gradient(145deg, rgba(8,8,16,0.97) 0%, rgba(20,4,4,0.97) 100%);
    border:1px solid rgba(220,0,0,0.5);
    border-radius:8px;
    padding:36px 48px;
    text-align:center;
    max-width:480px;
    box-shadow: 0 0 60px rgba(220,0,0,0.2), inset 0 1px 0 rgba(255,255,255,0.05);
    position:relative; overflow:hidden;
  }
  .screen::before {
    content:'';
    position:absolute; top:0; left:0; right:0; height:3px;
    background: linear-gradient(90deg, transparent, #cc0000, #ff6600, #cc0000, transparent);
  }
  .screen-title {
    font-family:'Orbitron', monospace;
    font-size:11px; font-weight:700;
    color:#cc0000; letter-spacing:4px;
    text-transform:uppercase; margin-bottom:8px;
  }
  .screen-name {
    font-family:'Orbitron', monospace;
    font-size:32px; font-weight:900;
    color:#fff;
    text-shadow: 0 0 30px rgba(255,80,0,0.6);
    line-height:1.1; margin-bottom:4px;
  }
  .screen-subtitle {
    font-family:'Rajdhani', sans-serif;
    font-size:16px; color:#888; margin-bottom:24px;
  }
  .invite-box {
    background: rgba(255,255,255,0.03);
    border:1px solid rgba(255,255,255,0.08);
    border-radius:6px;
    padding:16px 20px;
    margin-bottom:24px;
    font-family:'Rajdhani', sans-serif;
  }
  .invite-box .inv-line { font-size:13px; color:#666; margin-bottom:2px; }
  .invite-box .inv-detail { font-size:18px; color:#ccc; font-weight:600; }
  .invite-box .inv-venue { font-size:14px; color:#999; margin-top:4px; }
  .invite-box .inv-accent { color:#ff6600; }
  .start-btn {
    background: linear-gradient(135deg, #cc0000 0%, #ff3300 50%, #cc0000 100%);
    color:#fff;
    border:none; outline:none;
    padding:14px 44px;
    font-family:'Orbitron', monospace;
    font-size:15px; font-weight:700;
    letter-spacing:2px;
    border-radius:4px;
    cursor:pointer;
    position:relative;
    box-shadow: 0 4px 20px rgba(220,0,0,0.5);
    transition: transform 0.1s, box-shadow 0.1s;
  }
  .start-btn:hover { transform:translateY(-2px); box-shadow:0 6px 30px rgba(220,0,0,0.7); }
  .start-btn:active { transform:translateY(1px); }
  .controls-hint {
    margin-top:16px;
    font-family:'Rajdhani', sans-serif;
    font-size:13px; color:#444;
  }
  .controls-hint kbd {
    background:#1a1a2e; border:1px solid #333;
    border-radius:3px; padding:2px 7px; color:#888;
    font-family:'Orbitron', monospace; font-size:10px;
  }
  .go-score {
    font-family:'Orbitron', monospace;
    font-size:42px; font-weight:900;
    color:#ff6600;
    text-shadow: 0 0 20px rgba(255,100,0,0.5);
    margin:12px 0;
  }
  .go-label { font-family:'Rajdhani', sans-serif; font-size:13px; color:#555; letter-spacing:3px; }
  #muteBtn {
    position:absolute; top:10px; right:10px;
    background:rgba(0,0,0,0.6); border:1px solid #333;
    border-radius:4px; color:#666;
    font-family:'Rajdhani',sans-serif; font-size:12px;
    padding:4px 10px; cursor:pointer;
    transition:color 0.2s, border-color 0.2s;
  }
  #muteBtn:hover { color:#cc0000; border-color:#cc0000; }
  #muteBtn.muted { color:#333; }
</style>
</head>
<body>
<div id="wrap">
  <canvas id="c" width="900" height="500"></canvas>
  <div id="footer">
    <div>KAUSTUBH GRAND PRIX â€” <span>BIRTHDAY EDITION</span></div>
    <div>â†‘â†“ or W/S â€” SWITCH LANE &nbsp;|&nbsp; SPACE â€” BOOST</div>
    <div>Â© 2025 BIRTHDAY INVITE</div>
  </div>

  <div id="overlay">
    <div class="screen" id="startScreen">
      <div class="screen-title">ğŸ Grand Prix Invitation ğŸ</div>
      <div class="screen-name">KAUSTUBH<br>GRAND PRIX</div>
      <div class="screen-subtitle">4TH BIRTHDAY CHAMPIONSHIP</div>
      <div class="invite-box">
        <div class="inv-line">YOU ARE CORDIALLY INVITED TO</div>
        <div class="inv-detail">ğŸ‚ Kaustubh's <span class="inv-accent">4th Birthday</span> Party ğŸ‚</div>
        <div class="inv-detail" style="font-size:22px; margin-top:8px;"><span class="inv-accent">March 1st</span> â€” 5PM Onwards</div>
        <div class="inv-venue">ğŸ“ Brigade Cornerstone Utopia Clubhouse</div>
      </div>
      <button class="start-btn" id="startBtn">START RACE â€º</button>
      <div class="controls-hint">
        <kbd>â†‘</kbd> <kbd>â†“</kbd> Switch Lane &nbsp;Â·&nbsp; <kbd>SPACE</kbd> Boost &nbsp;Â·&nbsp; Dodge blue cars
      </div>
    </div>

    <div class="screen" id="gameOverScreen" style="display:none">
      <div class="screen-title">RACE TERMINATED</div>
      <div class="screen-name" style="font-size:24px; color:#cc0000;">CAR #4 RETIRED</div>
      <div class="go-label">FINAL CHAMPIONSHIP POINTS</div>
      <div class="go-score" id="finalScore">0</div>
      <div class="invite-box" style="margin-bottom:20px;">
        <div class="inv-line">REMEMBER â€” YOU'RE INVITED!</div>
        <div class="inv-detail"><span class="inv-accent">March 1st</span> Â· 5PM Onwards</div>
        <div class="inv-venue">Brigade Cornerstone Utopia Clubhouse</div>
      </div>
      <button class="start-btn" id="restartBtn">RESTART RACE â€º</button>
    </div>
  </div>

  <button id="muteBtn">ğŸ”Š SFX</button>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SETUP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const canvas = document.getElementById('c');
const ctx = canvas.getContext('2d');
const W = 900, H = 500;

// Road bounds
const R_TOP = 145;      // Road top y
const R_BOT = 448;      // Road bottom y
const R_MID = (R_TOP + R_BOT) / 2;   // 296.5
const LANE_Y = [R_TOP + (R_BOT - R_TOP) * 0.275, R_TOP + (R_BOT - R_TOP) * 0.725]; // ~205, ~389? 
// Let me recalculate: R_TOP=145, R_BOT=448, span=303
// Lane 1 center: 145 + 303*0.28 = 145+84.8 = ~230
// Lane 2 center: 145 + 303*0.72 = 145+218 = ~363

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  AUDIO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let AC, engineOsc, engineGain, muted = false;
function initAudio() {
  AC = new (window.AudioContext || window.webkitAudioContext)();
  engineGain = AC.createGain();
  engineGain.gain.value = 0.06;
  const lp = AC.createBiquadFilter();
  lp.type = 'lowpass'; lp.frequency.value = 800;
  engineOsc = AC.createOscillator();
  engineOsc.type = 'sawtooth';
  engineOsc.frequency.value = 90;
  engineOsc.connect(lp); lp.connect(engineGain); engineGain.connect(AC.destination);
  engineOsc.start();
}
function sfxHonk() {
  if (!AC || muted) return;
  const o = AC.createOscillator(), g = AC.createGain();
  o.type = 'square'; o.frequency.value = 380;
  g.gain.setValueAtTime(0.05, AC.currentTime);
  g.gain.exponentialRampToValueAtTime(0.001, AC.currentTime + 0.25);
  o.connect(g); g.connect(AC.destination);
  o.start(); o.stop(AC.currentTime + 0.25);
}
function sfxCrash() {
  if (!AC || muted) return;
  const buf = AC.createBuffer(1, AC.sampleRate * 0.5, AC.sampleRate);
  const d = buf.getChannelData(0);
  for (let i = 0; i < d.length; i++) d[i] = (Math.random() * 2 - 1) * (1 - i / d.length) * 0.8;
  const s = AC.createBufferSource(), g = AC.createGain();
  g.gain.value = 0.2;
  s.buffer = buf; s.connect(g); g.connect(AC.destination); s.start();
}
function sfxBoost() {
  if (!AC || muted) return;
  const o = AC.createOscillator(), g = AC.createGain();
  o.type = 'sawtooth'; o.frequency.setValueAtTime(200, AC.currentTime);
  o.frequency.exponentialRampToValueAtTime(500, AC.currentTime + 0.3);
  g.gain.setValueAtTime(0.08, AC.currentTime);
  g.gain.exponentialRampToValueAtTime(0.001, AC.currentTime + 0.5);
  o.connect(g); g.connect(AC.destination);
  o.start(); o.stop(AC.currentTime + 0.5);
}
document.getElementById('muteBtn').onclick = () => {
  muted = !muted;
  const btn = document.getElementById('muteBtn');
  btn.textContent = muted ? 'ğŸ”‡ SFX' : 'ğŸ”Š SFX';
  btn.classList.toggle('muted', muted);
  if (engineGain) engineGain.gain.value = muted ? 0 : 0.06;
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let gs = 'start'; // start | playing | over
let score = 0, lives = 3, spd = 4, frame = 0, shake = 0;
let boosting = false, boostCooldown = 0;
let invincible = 0;
let particles = [];
let enemies = [];
let spawnT = 0, spawnInterval = 110;

const PLAYER = { lane: 0, x: 160, y: LANE_Y[0], tY: LANE_Y[0], w: 116, h: 44 };

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PARALLAX LAYERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const clouds = Array.from({ length: 7 }, (_, i) => ({
  x: i * 150 + Math.random() * 80, y: 20 + Math.random() * 40,
  w: 90 + Math.random() * 100, h: 18 + Math.random() * 14,
  spd: 0.25 + Math.random() * 0.15
}));
let sceneX = { mtn: 0, stands: 0, back: 0, front: 0, dash: 0 };
let billX = W + 100;
let crowdT = 0;

// Billboard data (invite info)
const BILL_W = 220, BILL_H = 130;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PARTICLE SYSTEM
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function emitSmoke(x, y, r, g, b, spd_factor = 1) {
  for (let i = 0; i < 2; i++) {
    const a = 0.55 + Math.random() * 0.25;
    particles.push({
      type: 'smoke', x, y: y + (Math.random() - 0.5) * 8,
      vx: (-0.8 - Math.random() * 1.2) * spd_factor,
      vy: (Math.random() - 0.5) * 0.5,
      life: 1, decay: 0.018 + Math.random() * 0.015,
      rad: 5 + Math.random() * 7, r, g, b, baseA: a
    });
  }
}
function emitSparks(x, y) {
  for (let i = 0; i < 20; i++) {
    const a = (Math.PI * 2 * i) / 20 + Math.random() * 0.5;
    const s = 3 + Math.random() * 5;
    particles.push({
      type: 'spark', x, y,
      vx: Math.cos(a) * s, vy: Math.sin(a) * s,
      life: 1, decay: 0.04 + Math.random() * 0.03,
      rad: 2 + Math.random() * 3,
      r: 255, g: Math.floor(80 + Math.random() * 120), b: 0, baseA: 1
    });
  }
}
function emitSpeedLine(x, y) {
  particles.push({
    type: 'speedline', x, y,
    vx: -(18 + Math.random() * 12), vy: 0,
    life: 1, decay: 0.12, rad: 1, len: 40 + Math.random() * 60,
    r: 255, g: 200, b: 100, baseA: 0.4
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DRAWING â€” BACKGROUND
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function drawSky() {
  // Dusk/golden sky gradient
  const g = ctx.createLinearGradient(0, 0, 0, R_TOP);
  g.addColorStop(0, '#0d0b1f');
  g.addColorStop(0.35, '#1a0e2e');
  g.addColorStop(0.7, '#3d1a0a');
  g.addColorStop(1, '#7a3010');
  ctx.fillStyle = g;
  ctx.fillRect(0, 0, W, R_TOP + 5);

  // Horizon glow
  const hg = ctx.createLinearGradient(0, R_TOP - 40, 0, R_TOP);
  hg.addColorStop(0, 'transparent');
  hg.addColorStop(1, 'rgba(255,100,30,0.35)');
  ctx.fillStyle = hg;
  ctx.fillRect(0, R_TOP - 40, W, 40);
}
function drawClouds() {
  for (const c of clouds) {
    ctx.save();
    ctx.globalAlpha = 0.18;
    const g = ctx.createRadialGradient(c.x, c.y, 0, c.x, c.y, c.w / 1.8);
    g.addColorStop(0, '#ff9050');
    g.addColorStop(1, 'transparent');
    ctx.fillStyle = g;
    ctx.beginPath();
    ctx.ellipse(c.x, c.y, c.w / 1.8, c.h, 0, 0, Math.PI * 2);
    ctx.fill();
    ctx.restore();
    ctx.save();
    ctx.globalAlpha = 0.3;
    ctx.fillStyle = '#c06030';
    ctx.beginPath();
    ctx.ellipse(c.x, c.y, c.w / 2, c.h * 0.65, 0, 0, Math.PI * 2);
    ctx.fill();
    ctx.restore();
  }
}
function drawMountains() {
  const peaks = [
    { x: 0, y: R_TOP - 70 }, { x: 110, y: R_TOP - 95 }, { x: 210, y: R_TOP - 60 },
    { x: 310, y: R_TOP - 110 }, { x: 430, y: R_TOP - 75 }, { x: 540, y: R_TOP - 120 },
    { x: 650, y: R_TOP - 80 }, { x: 760, y: R_TOP - 105 }, { x: 870, y: R_TOP - 65 },
    { x: 950, y: R_TOP - 90 }
  ];
  // Far mountains
  for (let rep = -1; rep <= 1; rep++) {
    ctx.save();
    ctx.translate(sceneX.mtn + rep * W, 0);
    ctx.beginPath();
    ctx.moveTo(0, R_TOP);
    for (const p of peaks) ctx.lineTo(p.x, p.y);
    ctx.lineTo(W, R_TOP);
    ctx.closePath();
    const mg = ctx.createLinearGradient(0, R_TOP - 120, 0, R_TOP);
    mg.addColorStop(0, '#2a1a3a');
    mg.addColorStop(1, '#1a1028');
    ctx.fillStyle = mg;
    ctx.fill();
    // Snow caps
    ctx.fillStyle = 'rgba(200,180,220,0.12)';
    for (const p of peaks) {
      if (p.y < R_TOP - 80) {
        ctx.beginPath();
        ctx.moveTo(p.x - 15, p.y + 18);
        ctx.lineTo(p.x, p.y);
        ctx.lineTo(p.x + 15, p.y + 18);
        ctx.fill();
      }
    }
    ctx.restore();
  }
}
function drawGrandstand() {
  const STAND_TOP = R_TOP - 55;
  const STAND_H = 55;
  // Grandstand structure â€” back wall
  for (let rep = -1; rep <= 1; rep++) {
    ctx.save();
    ctx.translate(sceneX.stands + rep * W, 0);
    // Structure
    ctx.fillStyle = '#1c1c28';
    ctx.fillRect(0, STAND_TOP, W, STAND_H);
    // Roof
    ctx.fillStyle = '#111';
    ctx.fillRect(0, STAND_TOP, W, 8);
    ctx.fillStyle = '#cc0000';
    ctx.fillRect(0, STAND_TOP, W, 3);
    // Vertical pillars
    for (let i = 0; i <= W; i += 80) {
      ctx.fillStyle = '#252535';
      ctx.fillRect(i - 3, STAND_TOP + 8, 6, STAND_H - 8);
    }
    // Seat rows (3 rows of colored dots)
    const colors = ['#cc1111','#1144cc','#11aa33','#dddd11','#cc4400','#8811cc'];
    for (let row = 0; row < 3; row++) {
      const ry = STAND_TOP + 16 + row * 13;
      for (let s = 0; s < W; s += 12) {
        const seated = Math.sin(s * 0.3 + row * 1.7 + crowdT * 0.04) > 0.1;
        if (seated) {
          ctx.fillStyle = colors[(s + row * 3) % colors.length];
          ctx.beginPath();
          ctx.ellipse(s + 4, ry, 4, 4, 0, 0, Math.PI * 2);
          ctx.fill();
          // Wave arms occasionally
          if (Math.sin(s * 0.2 + crowdT * 0.07) > 0.7) {
            ctx.strokeStyle = colors[(s + row * 3) % colors.length];
            ctx.lineWidth = 1.5;
            ctx.beginPath();
            ctx.moveTo(s + 4, ry - 4);
            ctx.lineTo(s + 4 + Math.sin(crowdT * 0.09 + s) * 6, ry - 10);
            ctx.stroke();
          }
        }
      }
    }
    // Sponsor banners along pit wall top (just above road)
    const sponsors = ['#4 KAUSTUBH', 'MARCH 1ST', 'CELEBRATE!', 'BRIGADE CU', 'HAPPY B\'DAY'];
    for (let i = 0; i < sponsors.length; i++) {
      const bx = i * 200 - 60;
      const bColors = ['#cc0000', '#0044cc', '#117700', '#cc6600', '#880088'];
      ctx.fillStyle = bColors[i % bColors.length];
      ctx.fillRect(bx, R_TOP - 3, 180, 12);
      ctx.fillStyle = '#fff';
      ctx.font = 'bold 8px Rajdhani, sans-serif';
      ctx.textAlign = 'left';
      ctx.fillText(sponsors[i], bx + 8, R_TOP + 6);
    }
    ctx.restore();
  }
}
function drawRoad() {
  // Asphalt base
  const rg = ctx.createLinearGradient(0, R_TOP, 0, R_BOT);
  rg.addColorStop(0, '#1e1e1e');
  rg.addColorStop(0.5, '#242424');
  rg.addColorStop(1, '#1a1a1a');
  ctx.fillStyle = rg;
  ctx.fillRect(0, R_TOP, W, R_BOT - R_TOP);

  // Subtle asphalt texture (noise bands)
  for (let i = 0; i < 8; i++) {
    ctx.fillStyle = `rgba(255,255,255,${0.008 + Math.sin(i * 1.3) * 0.003})`;
    ctx.fillRect(0, R_TOP + i * ((R_BOT - R_TOP) / 8), W, 2);
  }

  // Kerbs (rumble strips) - top and bottom
  const kerbH = 10;
  const kerbCount = 30;
  const kerbW = W / kerbCount;
  for (let i = 0; i < kerbCount; i++) {
    const kx = i * kerbW - (sceneX.dash * 0.5 % kerbW);
    ctx.fillStyle = i % 2 === 0 ? '#cc0000' : '#ffffff';
    ctx.fillRect(kx, R_TOP, kerbW + 1, kerbH);
    ctx.fillRect(kx, R_BOT - kerbH, kerbW + 1, kerbH);
  }

  // Armco barriers (silver corrugated)
  const armcoY1 = R_TOP + kerbH;
  const armcoY2 = R_BOT - kerbH - 10;
  for (const ay of [armcoY1, armcoY2]) {
    const ag = ctx.createLinearGradient(0, ay, 0, ay + 8);
    ag.addColorStop(0, '#888');
    ag.addColorStop(0.5, '#ddd');
    ag.addColorStop(1, '#555');
    ctx.fillStyle = ag;
    ctx.fillRect(0, ay, W, 8);
    // Bolts
    for (let bx = 0; bx < W; bx += 30) {
      ctx.fillStyle = '#999';
      ctx.beginPath();
      ctx.arc(bx + 15, ay + 4, 2, 0, Math.PI * 2);
      ctx.fill();
    }
  }

  // Center dashes
  ctx.setLineDash([40, 25]);
  ctx.lineDashOffset = -(sceneX.dash % 65);
  ctx.strokeStyle = '#ffffff';
  ctx.lineWidth = 2.5;
  ctx.globalAlpha = 0.25;
  ctx.beginPath();
  ctx.moveTo(0, R_MID);
  ctx.lineTo(W, R_MID);
  ctx.stroke();
  ctx.setLineDash([]);
  ctx.globalAlpha = 1;

  // Lane separator dots
  for (let lx = 0; lx < W; lx += 60) {
    const ldx = (lx - sceneX.dash % 60 + W) % W;
    ctx.globalAlpha = 0.12;
    ctx.fillStyle = '#fff';
    ctx.beginPath();
    ctx.arc(ldx, R_MID, 3, 0, Math.PI * 2);
    ctx.fill();
  }
  ctx.globalAlpha = 1;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DRAWING â€” BILLBOARD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function drawBillboard(bx) {
  const by = R_TOP - BILL_H - 38;
  // Support poles
  ctx.fillStyle = '#2a2a3a';
  ctx.fillRect(bx + 30, by + BILL_H, 8, 44);
  ctx.fillRect(bx + BILL_W - 38, by + BILL_H, 8, 44);
  ctx.fillStyle = '#111';
  ctx.fillRect(bx + 20, by + BILL_H + 38, BILL_W - 12, 7);

  // Board bg
  ctx.save();
  ctx.beginPath();
  ctx.roundRect(bx, by, BILL_W, BILL_H, 5);
  ctx.clip();

  // Deep bg gradient
  const bg = ctx.createLinearGradient(bx, by, bx, by + BILL_H);
  bg.addColorStop(0, '#0a0014');
  bg.addColorStop(1, '#14000a');
  ctx.fillStyle = bg;
  ctx.fillRect(bx, by, BILL_W, BILL_H);

  // Checkered strip
  for (let i = 0; i < 16; i++) {
    ctx.fillStyle = i % 2 === 0 ? '#111' : '#eee';
    ctx.fillRect(bx + i * (BILL_W / 16), by, BILL_W / 16 + 1, 14);
  }

  // Content
  ctx.textAlign = 'center';
  const cx2 = bx + BILL_W / 2;

  ctx.fillStyle = '#FFD700';
  ctx.font = 'bold 10px Orbitron, monospace';
  ctx.fillText('YOU ARE INVITED', cx2, by + 30);

  ctx.fillStyle = '#ffffff';
  ctx.font = 'bold 17px Orbitron, monospace';
  ctx.fillText("KAUSTUBH'S", cx2, by + 52);

  ctx.fillStyle = '#ff4400';
  ctx.font = 'bold 22px Orbitron, monospace';
  ctx.fillText('4TH BIRTHDAY!', cx2, by + 75);

  ctx.fillStyle = '#FFD700';
  ctx.font = 'bold 11px Rajdhani, sans-serif';
  ctx.fillText('MARCH 1ST Â· 5PM ONWARDS', cx2, by + 96);

  ctx.fillStyle = '#aaa';
  ctx.font = '10px Rajdhani, sans-serif';
  ctx.fillText('BRIGADE CORNERSTONE', cx2, by + 112);
  ctx.fillText('UTOPIA CLUBHOUSE', cx2, by + 124);

  ctx.restore();

  // Border glow
  ctx.strokeStyle = '#cc0000';
  ctx.lineWidth = 2;
  ctx.beginPath();
  ctx.roundRect(bx, by, BILL_W, BILL_H, 5);
  ctx.stroke();
  ctx.strokeStyle = 'rgba(255,80,0,0.3)';
  ctx.lineWidth = 6;
  ctx.stroke();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DRAWING â€” TREES (background silhouette)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function drawTrees() {
  for (let rep = -1; rep <= 1; rep++) {
    ctx.save();
    ctx.translate(sceneX.back + rep * W, 0);
    for (let tx = -20; tx < W + 20; tx += 55) {
      const h = 30 + Math.sin(tx * 0.05) * 12;
      ctx.fillStyle = '#0a0a14';
      ctx.beginPath();
      ctx.moveTo(tx, R_TOP + 14);
      ctx.lineTo(tx - 12, R_TOP + 14 - h * 0.4);
      ctx.lineTo(tx - 8, R_TOP + 14 - h * 0.4);
      ctx.lineTo(tx - 13, R_TOP + 14 - h * 0.7);
      ctx.lineTo(tx - 7, R_TOP + 14 - h * 0.7);
      ctx.lineTo(tx, R_TOP + 14 - h);
      ctx.lineTo(tx + 7, R_TOP + 14 - h * 0.7);
      ctx.lineTo(tx + 13, R_TOP + 14 - h * 0.7);
      ctx.lineTo(tx + 8, R_TOP + 14 - h * 0.4);
      ctx.lineTo(tx + 12, R_TOP + 14 - h * 0.4);
      ctx.closePath();
      ctx.fill();
    }
    ctx.restore();
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DRAWING â€” F1 CAR  (the real meat)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function drawF1Car(cx, cy, isPlayer, num, blinkOn) {
  if (!blinkOn) return;
  ctx.save();
  ctx.translate(cx, cy);

  // Color palette
  const P = isPlayer
    ? { main: '#DC143C', dark: '#8b0000', mid: '#c01030', light: '#ff3355', cockpit: '#1a3a6a', visor: '#00aaff', helmetBase: '#FFD700', helmetStripe: '#cc0000' }
    : { main: '#1144cc', dark: '#001166', mid: '#0033aa', light: '#2266ee', cockpit: '#1a2a1a', visor: '#00ff88', helmetBase: '#333', helmetStripe: '#0066ff' };

  // â”€â”€ DROP SHADOW â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  ctx.save();
  ctx.globalAlpha = 0.35;
  ctx.fillStyle = '#000';
  ctx.beginPath();
  ctx.ellipse(0, 24, 60, 7, 0, 0, Math.PI * 2);
  ctx.fill();
  ctx.restore();

  // â”€â”€ REAR WING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // End plates
  ctx.fillStyle = P.dark;
  const rwx = -52;
  // Upper plane
  ctx.fillStyle = P.dark;
  ctx.beginPath();
  ctx.moveTo(rwx - 3, -28); ctx.lineTo(rwx + 22, -28);
  ctx.lineTo(rwx + 22, -23); ctx.lineTo(rwx - 3, -23);
  ctx.closePath(); ctx.fill();
  // Main plane
  ctx.fillStyle = P.mid;
  ctx.beginPath();
  ctx.moveTo(rwx - 2, -20); ctx.lineTo(rwx + 21, -20);
  ctx.lineTo(rwx + 21, -15); ctx.lineTo(rwx - 2, -15);
  ctx.closePath(); ctx.fill();
  // Pillars
  ctx.fillStyle = P.dark;
  ctx.fillRect(rwx + 4, -20, 4, 14);
  ctx.fillRect(rwx + 14, -20, 4, 14);
  // End plates
  ctx.fillStyle = P.dark;
  ctx.beginPath();
  ctx.roundRect(rwx - 4, -30, 5, 24, 2); ctx.fill();
  ctx.beginPath();
  ctx.roundRect(rwx + 21, -30, 5, 24, 2); ctx.fill();
  // Beam wing
  ctx.fillStyle = P.light;
  ctx.fillRect(rwx - 2, -12, 23, 3);

  // â”€â”€ REAR DIFFUSER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  ctx.save();
  ctx.fillStyle = '#111';
  ctx.beginPath();
  ctx.moveTo(-58, 12); ctx.lineTo(-30, 8);
  ctx.lineTo(-30, 20); ctx.lineTo(-58, 22);
  ctx.closePath(); ctx.fill();
  // Diffuser fins
  ctx.strokeStyle = '#333'; ctx.lineWidth = 1;
  for (let df = 0; df < 4; df++) {
    const dfx = -52 + df * 6;
    ctx.beginPath(); ctx.moveTo(dfx, 13); ctx.lineTo(dfx - 2, 20); ctx.stroke();
  }
  ctx.restore();

  // â”€â”€ MAIN BODY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // Main body shape
  ctx.fillStyle = P.main;
  ctx.beginPath();
  ctx.moveTo(-54, 20);        // rear bottom
  ctx.lineTo(64, 18);         // front bottom
  ctx.lineTo(72, 10);         // nose tip
  ctx.lineTo(64, 2);          // nose top
  ctx.lineTo(44, -2);         // nose-body join
  ctx.lineTo(28, -20);        // cockpit front edge
  ctx.lineTo(6, -22);         // cockpit top
  ctx.lineTo(-16, -18);       // cockpit rear
  ctx.lineTo(-30, -16);       // engine cover
  ctx.lineTo(-54, -4);        // rear top
  ctx.closePath();
  ctx.fill();

  // Sidepod highlight
  ctx.fillStyle = P.light;
  ctx.beginPath();
  ctx.moveTo(-20, -14); ctx.lineTo(20, -14);
  ctx.lineTo(24, -8); ctx.lineTo(-16, -6);
  ctx.closePath(); ctx.fill();

  // Engine cover center spine
  ctx.fillStyle = P.dark;
  ctx.beginPath();
  ctx.moveTo(-30, -8); ctx.lineTo(30, -16);
  ctx.lineTo(30, -20); ctx.lineTo(-30, -12);
  ctx.closePath(); ctx.fill();

  // â”€â”€ SIDEPOD INTAKE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  ctx.fillStyle = '#0a0a0a';
  ctx.beginPath();
  ctx.ellipse(20, -4, 12, 8, -0.2, 0, Math.PI * 2);
  ctx.fill();
  ctx.strokeStyle = P.dark; ctx.lineWidth = 1.5;
  ctx.stroke();

  // â”€â”€ COCKPIT / MONOCOQUE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  ctx.fillStyle = P.cockpit;
  ctx.beginPath();
  ctx.moveTo(10, -22); ctx.lineTo(26, -20);
  ctx.lineTo(26, -10); ctx.lineTo(10, -10);
  ctx.closePath(); ctx.fill();
  // Cockpit rim highlight
  ctx.strokeStyle = 'rgba(255,255,255,0.2)'; ctx.lineWidth = 1;
  ctx.stroke();

  // â”€â”€ HALO DEVICE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  ctx.strokeStyle = P.dark; ctx.lineWidth = 4;
  ctx.beginPath();
  ctx.moveTo(12, -22); ctx.bezierCurveTo(8, -32, 22, -32, 24, -22);
  ctx.stroke();
  ctx.strokeStyle = 'rgba(255,255,255,0.15)'; ctx.lineWidth = 2;
  ctx.stroke();
  // Halo center pillar
  ctx.strokeStyle = P.dark; ctx.lineWidth = 5;
  ctx.beginPath(); ctx.moveTo(18, -32); ctx.lineTo(18, -22); ctx.stroke();

  // â”€â”€ DRIVER HELMET â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const hx = 16, hy = -30;
  // Neck/collar
  ctx.fillStyle = P.main;
  ctx.beginPath();
  ctx.ellipse(hx, hy + 14, 7, 4, 0, 0, Math.PI * 2);
  ctx.fill();

  // Helmet main dome
  ctx.fillStyle = P.helmetBase;
  ctx.beginPath();
  ctx.moveTo(hx - 11, hy + 8);         // chin left
  ctx.bezierCurveTo(hx - 13, hy + 2, hx - 13, hy - 6, hx - 9, hy - 12);  // left side
  ctx.bezierCurveTo(hx - 5, hy - 18, hx + 3, hy - 20, hx + 8, hy - 18);   // crown
  ctx.bezierCurveTo(hx + 13, hy - 15, hx + 14, hy - 7, hx + 12, hy + 2);  // right side
  ctx.bezierCurveTo(hx + 11, hy + 8, hx + 8, hy + 10, hx + 2, hy + 10);   // chin right
  ctx.lineTo(hx - 5, hy + 10);
  ctx.closePath();
  ctx.fill();

  // Helmet stripe / livery
  ctx.fillStyle = P.helmetStripe;
  ctx.beginPath();
  ctx.moveTo(hx - 9, hy - 2); ctx.lineTo(hx + 12, hy - 4);
  ctx.lineTo(hx + 12, hy + 2); ctx.lineTo(hx - 9, hy + 4);
  ctx.closePath();
  ctx.save(); ctx.clip();
  ctx.fillStyle = P.helmetStripe;
  ctx.fill();
  ctx.restore();
  ctx.fill(); // fill stripe shape

  // Visor (key feature â€” trapezoidal, angled)
  ctx.fillStyle = P.visor;
  ctx.globalAlpha = 0.88;
  ctx.beginPath();
  ctx.moveTo(hx - 7, hy - 1);     // left top
  ctx.lineTo(hx + 11, hy - 4);    // right top
  ctx.lineTo(hx + 10, hy + 3);    // right bottom
  ctx.lineTo(hx - 8, hy + 5);     // left bottom
  ctx.closePath();
  ctx.fill();
  // Visor shine
  ctx.globalAlpha = 0.35;
  ctx.fillStyle = '#fff';
  ctx.beginPath();
  ctx.moveTo(hx - 4, hy - 1); ctx.lineTo(hx + 7, hy - 4);
  ctx.lineTo(hx + 6, hy - 1); ctx.lineTo(hx - 5, hy + 1);
  ctx.closePath();
  ctx.fill();
  ctx.globalAlpha = 1;

  // Visor edge/trim
  ctx.strokeStyle = 'rgba(0,0,0,0.5)'; ctx.lineWidth = 1;
  ctx.beginPath();
  ctx.moveTo(hx - 7, hy - 1); ctx.lineTo(hx + 11, hy - 4);
  ctx.lineTo(hx + 10, hy + 3); ctx.lineTo(hx - 8, hy + 5);
  ctx.closePath(); ctx.stroke();

  // Helmet chin trim
  ctx.fillStyle = P.dark;
  ctx.beginPath();
  ctx.moveTo(hx - 11, hy + 8); ctx.lineTo(hx + 2, hy + 10);
  ctx.lineTo(hx + 2, hy + 12); ctx.lineTo(hx - 11, hy + 10);
  ctx.closePath(); ctx.fill();

  // Helmet edge highlight
  ctx.strokeStyle = 'rgba(255,255,255,0.2)'; ctx.lineWidth = 1.2;
  ctx.beginPath();
  ctx.moveTo(hx - 11, hy + 8);
  ctx.bezierCurveTo(hx - 13, hy + 2, hx - 13, hy - 6, hx - 9, hy - 12);
  ctx.bezierCurveTo(hx - 5, hy - 18, hx + 3, hy - 20, hx + 8, hy - 18);
  ctx.stroke();

  // â”€â”€ DRIVER EYES (Kaustubh / generic) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  if (isPlayer) {
    // Visible face through visor (brown-haired boy)
    ctx.fillStyle = 'rgba(255,190,140,0.6)';
    ctx.beginPath();
    ctx.ellipse(hx, hy + 1, 5.5, 3.5, 0, 0, Math.PI * 2);
    ctx.fill();
    ctx.fillStyle = '#1a0a00';
    ctx.beginPath(); ctx.arc(hx - 2, hy, 1.2, 0, Math.PI * 2); ctx.fill();
    ctx.beginPath(); ctx.arc(hx + 2.5, hy - 0.5, 1.2, 0, Math.PI * 2); ctx.fill();
    // Hair hint
    ctx.fillStyle = 'rgba(80,40,20,0.8)';
    ctx.beginPath();
    ctx.moveTo(hx - 7, hy - 1); ctx.bezierCurveTo(hx-4, hy-14, hx+4, hy-14, hx+6, hy-12);
    ctx.lineTo(hx + 6, hy - 8); ctx.lineTo(hx - 7, hy - 5); ctx.closePath(); ctx.fill();
  }

  // â”€â”€ FRONT WING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // Nose underplane
  ctx.fillStyle = P.dark;
  ctx.beginPath();
  ctx.moveTo(62, 10); ctx.lineTo(48, 10); ctx.lineTo(44, 20); ctx.lineTo(62, 20);
  ctx.closePath(); ctx.fill();
  // Main front wing planes (2-element)
  ctx.fillStyle = P.main;
  ctx.beginPath();
  ctx.moveTo(55, 18); ctx.lineTo(30, 18); ctx.lineTo(32, 22); ctx.lineTo(57, 22);
  ctx.closePath(); ctx.fill();
  ctx.fillStyle = P.dark;
  ctx.beginPath();
  ctx.moveTo(58, 23); ctx.lineTo(28, 23); ctx.lineTo(30, 27); ctx.lineTo(60, 27);
  ctx.closePath(); ctx.fill();
  // Front wing endplates
  ctx.fillStyle = P.dark;
  ctx.beginPath(); ctx.roundRect(58, 16, 5, 14, 1); ctx.fill();
  ctx.beginPath(); ctx.roundRect(27, 16, 5, 14, 1); ctx.fill();
  // Canards
  ctx.fillStyle = P.mid;
  ctx.beginPath();
  ctx.moveTo(55, 16); ctx.lineTo(50, 10); ctx.lineTo(54, 10); ctx.lineTo(58, 16); ctx.fill();
  ctx.beginPath();
  ctx.moveTo(32, 16); ctx.lineTo(28, 10); ctx.lineTo(32, 10); ctx.lineTo(35, 16); ctx.fill();

  // â”€â”€ WHEELS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const wheelSpin = frame * 0.28;
  function drawWheel(wx, wradOuter, wradInner, isRear) {
    // Tire
    ctx.fillStyle = '#111';
    ctx.beginPath(); ctx.ellipse(wx, 20, wradOuter, wradOuter * 0.45, 0, 0, Math.PI * 2); ctx.fill();
    ctx.strokeStyle = '#2a2a2a'; ctx.lineWidth = 2;
    ctx.stroke();
    // Rim
    ctx.fillStyle = '#777';
    ctx.beginPath(); ctx.ellipse(wx, 20, wradInner, wradInner * 0.45, 0, 0, Math.PI * 2); ctx.fill();
    // Spokes (5)
    for (let sp = 0; sp < 5; sp++) {
      const sa = wheelSpin + sp * (Math.PI * 2 / 5);
      const sx1 = wx + Math.cos(sa) * (wradInner * 0.85);
      const sy1 = 20 + Math.sin(sa) * (wradInner * 0.85 * 0.45);
      const sx2 = wx + Math.cos(sa + Math.PI) * (wradInner * 0.85);
      const sy2 = 20 + Math.sin(sa + Math.PI) * (wradInner * 0.85 * 0.45);
      ctx.strokeStyle = '#555'; ctx.lineWidth = 2;
      ctx.beginPath(); ctx.moveTo(sx1, sy1); ctx.lineTo(sx2, sy2); ctx.stroke();
    }
    // Hub
    ctx.fillStyle = P.light;
    ctx.beginPath(); ctx.ellipse(wx, 20, 4, 2, 0, 0, Math.PI * 2); ctx.fill();
    // Brake caliper (red)
    ctx.fillStyle = '#cc2200';
    ctx.beginPath(); ctx.ellipse(wx + wradInner * 0.5, 20, 4, 2, 0, 0, Math.PI * 2); ctx.fill();
    // Suspension arm
    if (!isRear) {
      ctx.strokeStyle = P.dark; ctx.lineWidth = 3;
      ctx.beginPath(); ctx.moveTo(wx - 5, 12); ctx.lineTo(20, 6); ctx.stroke();
      ctx.beginPath(); ctx.moveTo(wx - 5, 18); ctx.lineTo(20, 14); ctx.stroke();
    } else {
      ctx.strokeStyle = P.dark; ctx.lineWidth = 3;
      ctx.beginPath(); ctx.moveTo(wx + 5, 12); ctx.lineTo(-20, 4); ctx.stroke();
      ctx.beginPath(); ctx.moveTo(wx + 5, 18); ctx.lineTo(-20, 12); ctx.stroke();
    }
  }
  drawWheel(40, 11, 7, false);   // front wheel
  drawWheel(-36, 13, 8.5, true); // rear wheel

  // â”€â”€ FLOOR PLATE / UNDERTRAY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  ctx.fillStyle = P.dark;
  ctx.beginPath();
  ctx.moveTo(-50, 20); ctx.lineTo(62, 20); ctx.lineTo(62, 22); ctx.lineTo(-50, 22);
  ctx.closePath(); ctx.fill();

  // â”€â”€ CAR NUMBER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  ctx.save();
  // Number plate on sidepod
  ctx.fillStyle = isPlayer ? '#fff' : '#fff';
  ctx.fillRect(-10, -12, 22, 16);
  ctx.fillStyle = isPlayer ? '#cc0000' : '#0033aa';
  ctx.fillRect(-10, -12, 22, 4);
  ctx.font = 'bold 11px Orbitron, monospace';
  ctx.textAlign = 'center';
  ctx.fillStyle = '#111';
  ctx.fillText(num, 1, 1);
  ctx.restore();

  // â”€â”€ EXHAUST GLOW â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  if (isPlayer && boosting) {
    const eg = ctx.createLinearGradient(-55, 0, -80, 0);
    eg.addColorStop(0, 'rgba(255,160,0,0.9)');
    eg.addColorStop(0.4, 'rgba(255,80,0,0.6)');
    eg.addColorStop(1, 'rgba(255,200,50,0)');
    ctx.fillStyle = eg;
    ctx.beginPath();
    ctx.moveTo(-52, -3); ctx.lineTo(-78 + Math.random() * 8, 8);
    ctx.lineTo(-52, 16); ctx.closePath(); ctx.fill();
  }
  // Exhaust heat shimmer always
  const exg = ctx.createLinearGradient(-54, 0, -65, 0);
  exg.addColorStop(0, `rgba(${isPlayer ? '255,100,30' : '100,150,255'},0.5)`);
  exg.addColorStop(1, 'rgba(0,0,0,0)');
  ctx.fillStyle = exg;
  ctx.beginPath();
  ctx.ellipse(-56, 8, 6, 4, 0, 0, Math.PI * 2);
  ctx.fill();

  ctx.restore();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DRAWING â€” HUD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function drawHUD() {
  ctx.save();
  // â”€â”€ Top bar (broadcast-style) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // Left: Position + name
  ctx.fillStyle = 'rgba(0,0,0,0.75)';
  ctx.beginPath(); ctx.roundRect(8, 8, 200, 38, 3); ctx.fill();
  ctx.strokeStyle = 'rgba(255,255,255,0.08)'; ctx.lineWidth = 1;
  ctx.stroke();
  ctx.fillStyle = '#cc0000';
  ctx.beginPath(); ctx.roundRect(8, 8, 36, 38, 3); ctx.fill();
  ctx.font = 'bold 20px Orbitron, monospace';
  ctx.textAlign = 'center'; ctx.fillStyle = '#fff';
  ctx.fillText('P1', 26, 33);
  ctx.font = 'bold 10px Orbitron, monospace';
  ctx.textAlign = 'left'; ctx.fillStyle = '#fff';
  ctx.fillText('KAUSTUBH', 52, 24);
  ctx.font = '9px Rajdhani, sans-serif'; ctx.fillStyle = '#888';
  ctx.fillText('CAR #4 Â· BIRTHDAY GP', 52, 38);

  // Right: Score
  ctx.fillStyle = 'rgba(0,0,0,0.75)';
  ctx.beginPath(); ctx.roundRect(W - 180, 8, 172, 38, 3); ctx.fill();
  ctx.strokeStyle = 'rgba(255,255,255,0.08)'; ctx.lineWidth = 1; ctx.stroke();
  ctx.font = '9px Rajdhani, sans-serif'; ctx.textAlign = 'right';
  ctx.fillStyle = '#888'; ctx.fillText('CHAMPIONSHIP PTS', W - 12, 22);
  ctx.font = 'bold 22px Orbitron, monospace'; ctx.fillStyle = '#FFD700';
  ctx.fillText(String(score).padStart(5, '0'), W - 12, 42);

  // Center: Lives as car icons
  ctx.fillStyle = 'rgba(0,0,0,0.75)';
  ctx.beginPath(); ctx.roundRect(W / 2 - 70, 8, 140, 38, 3); ctx.fill();
  ctx.strokeStyle = 'rgba(255,255,255,0.08)'; ctx.lineWidth = 1; ctx.stroke();
  ctx.font = '9px Rajdhani, sans-serif'; ctx.textAlign = 'center';
  ctx.fillStyle = '#555'; ctx.fillText('REMAINING', W / 2, 21);
  for (let i = 0; i < 3; i++) {
    ctx.fillStyle = i < lives ? '#cc0000' : '#222';
    ctx.beginPath(); ctx.roundRect(W / 2 - 40 + i * 28, 24, 22, 14, 2); ctx.fill();
    ctx.fillStyle = i < lives ? '#fff' : '#333';
    ctx.font = 'bold 8px Orbitron, monospace'; ctx.textAlign = 'center';
    ctx.fillText('#4', W / 2 - 29 + i * 28, 34);
  }

  // Bottom bar: Speed + Boost gauge
  const barH = 46;
  ctx.fillStyle = 'rgba(0,0,0,0.8)';
  ctx.beginPath(); ctx.roundRect(8, H - barH - 8, 260, barH, 4); ctx.fill();
  ctx.strokeStyle = 'rgba(255,255,255,0.06)'; ctx.lineWidth = 1; ctx.stroke();

  // Speed arc
  const arcCx = 42, arcCy = H - 30, arcR = 22;
  ctx.strokeStyle = '#1a1a1a'; ctx.lineWidth = 5;
  ctx.beginPath(); ctx.arc(arcCx, arcCy, arcR, Math.PI * 0.75, Math.PI * 2.25); ctx.stroke();
  const speedFrac = Math.min((spd - 3) / 7, 1);
  const grad = ctx.createLinearGradient(-arcR, 0, arcR, 0);
  grad.addColorStop(0, '#0066ff'); grad.addColorStop(0.6, '#ff6600'); grad.addColorStop(1, '#ff0000');
  ctx.strokeStyle = grad; ctx.lineWidth = 5;
  ctx.beginPath();
  ctx.arc(arcCx, arcCy, arcR, Math.PI * 0.75, Math.PI * 0.75 + speedFrac * Math.PI * 1.5);
  ctx.stroke();
  ctx.font = 'bold 12px Orbitron, monospace'; ctx.textAlign = 'center';
  ctx.fillStyle = '#fff'; ctx.fillText(Math.round(spd * 40), arcCx, arcCy + 4);
  ctx.font = '7px Rajdhani, sans-serif'; ctx.fillStyle = '#555';
  ctx.fillText('KM/H', arcCx, arcCy + 14);

  // Boost bar
  ctx.font = '8px Rajdhani, sans-serif'; ctx.textAlign = 'left';
  ctx.fillStyle = '#555'; ctx.fillText('BOOST CHARGE', 78, H - 45);
  const boostFrac = boostCooldown > 0 ? (boostCooldown > 180 ? 1 : boostCooldown / 180) : 1;
  const boostAvail = boostCooldown === 0 || boostCooldown > 180;
  ctx.fillStyle = '#1a1a1a';
  ctx.beginPath(); ctx.roundRect(78, H - 40, 180, 10, 2); ctx.fill();
  const bg = ctx.createLinearGradient(78, 0, 258, 0);
  bg.addColorStop(0, boosting ? '#ff6600' : (boostAvail ? '#00ff88' : '#0066ff'));
  bg.addColorStop(1, boosting ? '#ffcc00' : (boostAvail ? '#00cc44' : '#0044aa'));
  ctx.fillStyle = bg;
  ctx.beginPath(); ctx.roundRect(78, H - 40, Math.max(4, 180 * (boosting ? 1 : boostFrac)), 10, 2); ctx.fill();
  ctx.font = 'bold 9px Orbitron, monospace'; ctx.textAlign = 'left';
  ctx.fillStyle = boosting ? '#ff6600' : (boostAvail ? '#00ff88' : '#444');
  ctx.fillText(boosting ? 'âš¡ BOOST ACTIVE' : (boostAvail ? 'âš¡ READY' : 'RECHARGING...'), 78, H - 20);

  // DRS indicator (decorative)
  ctx.fillStyle = 'rgba(0,0,0,0.8)';
  ctx.beginPath(); ctx.roundRect(W - 120, H - barH - 8, 112, barH, 4); ctx.fill();
  ctx.strokeStyle = 'rgba(255,255,255,0.06)'; ctx.lineWidth = 1; ctx.stroke();
  const drsOn = boosting;
  ctx.fillStyle = drsOn ? '#00ff88' : '#222';
  ctx.beginPath(); ctx.roundRect(W - 116, H - 46, 50, 34, 3); ctx.fill();
  ctx.font = 'bold 12px Orbitron, monospace'; ctx.textAlign = 'center';
  ctx.fillStyle = drsOn ? '#000' : '#333';
  ctx.fillText('DRS', W - 91, H - 27);
  // KERS
  ctx.fillStyle = boosting ? '#ff6600' : '#1a1a1a';
  ctx.beginPath(); ctx.roundRect(W - 62, H - 46, 50, 34, 3); ctx.fill();
  ctx.font = 'bold 11px Orbitron, monospace'; ctx.textAlign = 'center';
  ctx.fillStyle = boosting ? '#000' : '#333';
  ctx.fillText('ERS', W - 37, H - 27);

  ctx.restore();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PARTICLES DRAW
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function drawParticles() {
  for (const p of particles) {
    ctx.globalAlpha = p.life * p.baseA;
    if (p.type === 'speedline') {
      ctx.strokeStyle = `rgb(${p.r},${p.g},${p.b})`;
      ctx.lineWidth = 1;
      ctx.beginPath(); ctx.moveTo(p.x, p.y); ctx.lineTo(p.x + p.len, p.y); ctx.stroke();
    } else {
      ctx.fillStyle = `rgb(${p.r},${p.g},${p.b})`;
      ctx.beginPath(); ctx.arc(p.x, p.y, p.rad, 0, Math.PI * 2); ctx.fill();
    }
  }
  ctx.globalAlpha = 1;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FULL SCENE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function draw() {
  ctx.save();
  if (shake > 0) {
    ctx.translate((Math.random() - 0.5) * shake, (Math.random() - 0.5) * shake);
    shake *= 0.75; if (shake < 0.3) shake = 0;
  }

  drawSky();
  drawClouds();
  drawMountains();
  drawGrandstand();
  drawTrees();
  drawBillboard(billX);
  if (billX < -BILL_W - 10) drawBillboard(billX + W + BILL_W + 200); // wrap preview
  drawRoad();
  drawParticles();

  // Enemies
  for (const e of enemies) {
    const blink = invincible <= 0 || frame % 6 < 3;
    drawF1Car(e.x, e.y, false, e.num, true);
    // Smoke from enemy exhaust
  }

  // Player
  const playerBlink = invincible <= 0 || frame % 6 < 3;
  drawF1Car(PLAYER.x, PLAYER.y, true, 4, playerBlink);

  drawHUD();
  ctx.restore();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  UPDATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const keys = {};
let lastLaneSwitch = 0;

document.addEventListener('keydown', e => {
  keys[e.code] = true;
  if (gs !== 'playing') return;
  const now = Date.now();
  if ((e.code === 'ArrowUp' || e.code === 'KeyW') && PLAYER.lane > 0 && now - lastLaneSwitch > 180) {
    PLAYER.lane = 0; PLAYER.tY = LANE_Y[0]; lastLaneSwitch = now;
  }
  if ((e.code === 'ArrowDown' || e.code === 'KeyS') && PLAYER.lane < 1 && now - lastLaneSwitch > 180) {
    PLAYER.lane = 1; PLAYER.tY = LANE_Y[1]; lastLaneSwitch = now;
  }
  if (e.code === 'Space' && boostCooldown === 0 && !boosting) {
    boosting = true; boostCooldown = 240; sfxBoost();
    e.preventDefault();
  }
});
document.addEventListener('keyup', e => { keys[e.code] = false; });

// Touch
let ts = 0;
canvas.addEventListener('touchstart', e => { ts = e.touches[0].clientY; e.preventDefault(); }, { passive: false });
canvas.addEventListener('touchend', e => {
  if (gs !== 'playing') return;
  const dy = e.changedTouches[0].clientY - ts;
  const now = Date.now();
  if (now - lastLaneSwitch > 180) {
    lastLaneSwitch = now;
    if (dy < -25 && PLAYER.lane > 0) { PLAYER.lane = 0; PLAYER.tY = LANE_Y[0]; }
    if (dy > 25 && PLAYER.lane < 1) { PLAYER.lane = 1; PLAYER.tY = LANE_Y[1]; }
    if (Math.abs(dy) < 25 && boostCooldown === 0 && !boosting) { boosting = true; boostCooldown = 240; sfxBoost(); }
  }
}, { passive: false });

function update() {
  frame++;
  crowdT++;
  const s = boosting ? spd * 1.85 : spd;

  // Parallax
  sceneX.mtn = (sceneX.mtn - s * 0.15) % W;
  sceneX.stands = (sceneX.stands - s * 0.35) % W;
  sceneX.back = (sceneX.back - s * 0.55) % W;
  sceneX.dash += s * 1.8;
  billX -= s * 0.7;
  if (billX < -BILL_W - 10) billX = W + 80;
  for (const c of clouds) { c.x -= c.spd; if (c.x < -c.w) c.x = W + c.w; }

  // Player smooth movement
  PLAYER.y += (PLAYER.tY - PLAYER.y) * 0.15;

  // Boost management
  if (boosting) {
    boostCooldown--;
    if (boostCooldown <= 60) { boosting = false; } // active for 180 frames, then cooldown 60
  } else if (boostCooldown > 0) {
    boostCooldown--;
  }

  // Engine pitch
  if (AC && engineOsc) engineOsc.frequency.value = boosting ? 160 : 85 + spd * 7;

  // Player exhaust smoke
  if (frame % 3 === 0) {
    emitSmoke(PLAYER.x - 64, PLAYER.y + 7, 180, 180, 180);
    if (boosting) {
      emitSmoke(PLAYER.x - 68, PLAYER.y + 7, 255, 140, 30, 1.5);
      if (frame % 2 === 0) emitSpeedLine(PLAYER.x - 20, PLAYER.y - 15 + Math.random() * 30);
    }
  }

  // Enemy spawn
  spawnT++;
  if (spawnT >= spawnInterval) {
    spawnT = 0;
    spawnInterval = Math.max(40, 110 - score * 0.05);
    const lane = Math.random() < 0.5 ? 0 : 1;
    enemies.push({ x: W + 80, y: LANE_Y[lane], lane, num: Math.floor(Math.random() * 25) + 5, w: 116, h: 44 });
    if (Math.random() < 0.15) sfxHonk();
  }

  // Update enemies
  for (const e of enemies) {
    e.x -= s + 3.5;
    e.y += (LANE_Y[e.lane] - e.y) * 0.1;
    if (frame % 4 === 0) emitSmoke(e.x + 64, e.y + 7, 130, 160, 220);
  }
  enemies = enemies.filter(e => e.x > -100);

  // Collisions
  if (invincible > 0) {
    invincible--;
  } else {
    for (const e of enemies) {
      if (Math.abs(PLAYER.x - e.x) < 80 && Math.abs(PLAYER.y - e.y) < 32) {
        lives--;
        invincible = 150;
        shake = 18;
        emitSparks(PLAYER.x, PLAYER.y);
        sfxCrash();
        if (lives <= 0) {
          gs = 'over';
          document.getElementById('finalScore').textContent = String(score).padStart(5, '0');
          document.getElementById('gameOverScreen').style.display = '';
          if (engineGain) engineGain.gain.value = 0;
        }
        break;
      }
    }
  }

  // Score & speed
  if (frame % 12 === 0) score++;
  spd = 4 + score / 120;

  // Particles
  for (const p of particles) {
    p.x += p.vx; p.y += p.vy;
    p.vy += p.type === 'smoke' ? -0.04 : 0.18;
    p.life -= p.decay;
    if (p.type === 'smoke') p.rad *= 1.015;
  }
  particles = particles.filter(p => p.life > 0 && p.rad > 0.3);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  GAME LOOP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function resetGame() {
  score = 0; lives = 3; spd = 4; frame = 0; shake = 0;
  boosting = false; boostCooldown = 0; invincible = 0;
  PLAYER.lane = 0; PLAYER.y = LANE_Y[0]; PLAYER.tY = LANE_Y[0];
  enemies = []; particles = []; spawnT = 0; spawnInterval = 110;
  billX = W + 100;
  sceneX = { mtn: 0, stands: 0, back: 0, front: 0, dash: 0 };
}

function loop() {
  if (gs === 'playing') update();
  else {
    // Idle animation
    crowdT++;
    sceneX.mtn = (sceneX.mtn - 0.4) % W;
    sceneX.stands = (sceneX.stands - 0.8) % W;
    sceneX.back = (sceneX.back - 1.2) % W;
    sceneX.dash += 3;
    billX -= 1.2; if (billX < -BILL_W - 10) billX = W + 80;
    for (const c of clouds) { c.x -= c.spd; if (c.x < -c.w) c.x = W + c.w; }
  }
  draw();
  requestAnimationFrame(loop);
}

document.getElementById('startBtn').onclick = () => {
  document.getElementById('startScreen').style.display = 'none';
  initAudio();
  if (muted && engineGain) engineGain.gain.value = 0;
  resetGame();
  gs = 'playing';
};
document.getElementById('restartBtn').onclick = () => {
  document.getElementById('gameOverScreen').style.display = 'none';
  if (engineGain) engineGain.gain.value = muted ? 0 : 0.06;
  resetGame();
  gs = 'playing';
};

loop();
</script>
</body>
</html>
